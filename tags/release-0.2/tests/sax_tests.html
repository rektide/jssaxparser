<html>
  <head>
    <script language="JavaScript" src="../jsunit/app/jsUnitCore.js"></script>
    <script language="JavaScript" src="../jssaxparser/sax.js"></script>
    <script language="JavaScript" src="../jssaxparser/dom_content_handler.js"></script>
    <script language="JavaScript" src="../examples/xml_samples.js"></script>
	<script language="JavaScript" src="manageWhiteSpace.js"></script>
    <script language="JavaScript">
    
    var contentHandler;
    var saxParser;
    
    function setUp() {
        contentHandler = new DomContentHandler();
		saxParser = new SAXParser(contentHandler);
    }
    
    function testParse_xml1() {
        var xml = loadXml();
        parse(xml);
    }
    
    function testParse_xml2() {
        var xml = loadXml2();
        parse(xml);
    }
    
    function testParse_xml3() {
        var xml = loadXml3();
        parse(xml);
    }
    
    function testParse_relaxng() {
        var xml = loadRelaxng();
        parse(xml);
    }
    
    function testParse_relaxng2() {
        var xml = loadRelaxng2();
        parse(xml);
    }
    
    function testParse_relaxng3() {
        var xml = loadRelaxng3();
        parse(xml);
    }
    
    function parse(xml) {
        saxParser.parse(xml);
        assertXmlEquals(createDocumentFromText(xml).documentElement, contentHandler.document.documentElement);
    }
	
	function assertXmlEquals(expected, result) {
		assertEquals("different nodes types", expected.nodeType, result.nodeType);
		//text nodes
		if (expected.nodeType == 3) {
			assertEquals("different text content", data_of(expected), data_of(result));
		} else if (expected.nodeType == 1) {
			assertEquals("different node names", expected.nodeName, result.nodeName);
			var attsExpected = expected.attributes;
			var attsResult = result.attributes;
			//remove namespaces declaration from attributes, not supported
			for (var i = 0 ; i < attsExpected.length ; i++) {
				var attExpected = attsExpected.item(i);
				if (/^xmlns/.test(attExpected.nodeName)) {
					expected.removeAttributeNode(attExpected);
					i--;
				}
			}
			for (var i = 0 ; i < attsResult.length ; i++) {
				var attResult = attsResult.item(i);
				if (/^xmlns/.test(attResult.nodeName)) {
					result.removeAttributeNode(attResult);
					i--;
				}
			}
			assertEquals("different number of attributes on node " + result.nodeName, attsExpected.length, attsResult.length);
			assertAttributesEquals(attsExpected, attsResult);
			var childNodesExpected = expected.childNodes;
			var childNodesResult = result.childNodes;
			//remove ignorables child nodes
			for (var i = 0 ; i < childNodesExpected.length ; i++) {
				var childNodeExpected = childNodesExpected.item(i);
				if (is_ignorable(childNodeExpected)) {
					expected.removeChild(childNodeExpected);
					i--;
				}
			}
			for (var i = 0 ; i < childNodesResult.length ; i++) {
				var childNodeResult = childNodesResult.item(i);
				if (is_ignorable(childNodeResult)) {
					result.removeChild(childNodeResult);
					i--;
				}
			}
			assertEquals("different number of children nodes under " + result.nodeName, childNodesExpected.length, childNodesResult.length);
			for (var i = 0 ; i < childNodesExpected.length ; i++) {
				assertXmlEquals(childNodesExpected.item(i), childNodesResult.item(i));
			}
		}
    }
    
	function assertAttributesEquals(attsExpected, attsResult) {
		for (var i = 0 ; i < attsExpected.length ; i++) {
			var attExpected = attsExpected.item(i);
			var attFound = false;
			for (var i = 0 ; i < attsResult.length && !attFound; i++) {
				var attResult = attsResult.item(i);
				if (attResult.nodeName == attExpected.nodeName) {
					attFound = true;
					assertEquals("invalid value of attribute " + attResult.nodeName, attExpected.value, attResult.value);
				}
			}
			assertTrue("missing attribute " + attExpected.nodeName, attFound);
		}
	}
	
    /*
            comes from http://www.w3schools.com/dom/tryit.asp?filename=note_parsertest2
           */
    function createDocumentFromText(text) {
        // code for IE
        if (window.ActiveXObject) {
            var doc=new ActiveXObject("Microsoft.XMLDOM");
            doc.async="false";
            doc.loadXML(text);
        }
        // code for Mozilla, Firefox, Opera, etc.
        else {
            var parser=new DOMParser();
            var doc=parser.parseFromString(text,"text/xml");
        }
        return doc;
    }
    
    </script>
  </head>
  <body>
    This is a Test Page for sax.js
  </body>
</html>
